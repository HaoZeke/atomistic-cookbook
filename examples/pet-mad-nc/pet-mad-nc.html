<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="search" title="Search" href="../../search.html" /><link rel="next" title="Multiple time stepping and ring-polymer contraction" href="../pi-mts-rpc/mts-rpc.html" /><link rel="prev" title="Long-stride trajectories with a universal FlashMD model" href="../flashmd/flashmd-demo.html" />
        <link rel="canonical" href="https://atomistic-cookbook.org/examples/pet-mad-nc/pet-mad-nc.html" />

    <link rel="shortcut icon" href="../../_static/cookbook-icon.png"/><!-- Generated with Sphinx 8.2.3 and Furo 2024.08.06 -->
        <title>MD using direct-force predictions with PET-MAD - The Atomistic Cookbook</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../../_static/cookbook.css?v=d86cfb60" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=302659d7" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">The Atomistic Cookbook</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../../_static/cookbook-icon.svg" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">The Atomistic Cookbook</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../topics/index.html">Recipes grouped by topic</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Recipes grouped by topic</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../topics/sampling.html">Statistical sampling and dynamics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../topics/analysis.html">Analysis and post-processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../topics/ml-models.html">Machine learning models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../topics/nqes.html">Nuclear quantum effects</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../software/index.html">Recipes grouped by software used</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Recipes grouped by software used</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../software/i-pi.html">i-PI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/chemiscope.html">chemiscope</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/featomic.html">featomic</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/scikit-matter.html">scikit-matter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/cp2k.html">cp2k</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/lammps.html">LAMMPS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/metatensor.html">metatensor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/plumed.html">PLUMED</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/torch-pme.html">torch-pme</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="../../all-examples.html">List of all recipes</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of List of all recipes</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../dos-align/dos-align.html">A ML model for the electron density of states</a></li>
<li class="toctree-l2"><a class="reference internal" href="../water-model/water-model.html">Atomistic Water Model for Molecular Dynamics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../batch-cp2k/reference-trajectory.html">Batch run of CP2K calculations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../thermostats/thermostats.html">Constant-temperature MD and thermostats</a></li>
<li class="toctree-l2"><a class="reference internal" href="../polarizability/polarizability.html">Equivariant linear model for polarizability</a></li>
<li class="toctree-l2"><a class="reference internal" href="../learn-tensors-with-mcov/learn-tensors-with-mcov.html">Equivariant model for tensorial properties based on scalar features</a></li>
<li class="toctree-l2"><a class="reference internal" href="../roy-gch/roy-gch.html">Generalized Convex Hull construction for the polymorphs of ROY</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hamiltonian-qm7/hamiltonian-qm7.html">Hamiltonian Learning for Molecules with Indirect Targets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../torchpme/torchpme_learning.html">Learning Capabilities with torchpme</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lpr/lpr.html">Local Prediction Rigidity analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lode-linear/lode-linear.html">Long-distance Equivariants: a tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="../flashmd/flashmd-demo.html">Long-stride trajectories with a universal FlashMD model</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">MD using direct-force predictions with PET-MAD</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pi-mts-rpc/mts-rpc.html">Multiple time stepping and ring-polymer contraction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gaas-map/gaas-map.html">PCA/PCovR Visualization of a training dataset for a potential</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pi-metad/pi-metad.html">Path integral metadynamics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../path-integrals/path-integrals.html">Path integral molecular dynamics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../periodic-hamiltonian/periodic-hamiltonian.html">Periodic Hamiltonian learning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../heat-capacity/heat-capacity.html">Quantum heat capacity of water</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rotate-equivariants/rotate-equivariants.html">Rotating equivariants</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sample-selection/sample-selection.html">Sample and Feature Selection with FPS and CUR</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pet-mad/pet-mad.html">The PET-MAD universal potential</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../downloading.html">Downloading and running the recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing a recipe</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#sphx-glr-download-examples-pet-mad-nc-pet-mad-nc-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code.</p>
</div>
<section class="sphx-glr-example-title" id="md-using-direct-force-predictions-with-pet-mad">
<span id="sphx-glr-examples-pet-mad-nc-pet-mad-nc-py"></span><h1>MD using direct-force predictions with PET-MAD<a class="headerlink" href="#md-using-direct-force-predictions-with-pet-mad" title="Link to this heading">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Authors<span class="colon">:</span></dt>
<dd class="field-odd"><p>Michele Ceriotti <a class="reference external" href="https://github.com/ceriottm">&#64;ceriottm</a>,
Filippo Bigi <a class="reference external" href="https://github.com/frostedoyster">&#64;frostedoyster</a></p>
</dd>
</dl>
<p>Evaluating forces as a direct output of a ML model accelerates their evaluation,
by up to a factor of 3 in comparison to the traditional approach that evaluates
them as derivatives of the interatomic potential.
Unfortunately, as discussed e.g. in
<a class="reference external" href="https://arxiv.org/abs/2412.11569">this preprint</a>, doing so means
that forces are not conservative, leading to instabilities and artefacts
in many modeling tasks, such as constant-energy molecular dynamics.
Here we demonstrate the issues associated with direct force predictions,
and ways to mitigate them, using the generally-applicable
<a class="reference external" href="https://arxiv.org/abs/2503.14118">PET-MAD potential</a>. See also
<a class="reference external" href="https://atomistic-cookbook.org/examples/pet-mad/pet-mad.html">this recipe</a>
for examples of using PET-MAD for basic tasks such as geometry optimization
and conservative MD.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># sphinx_gallery_thumbnail_number = 2</span>
</pre></div>
</div>
<p>If you don’t want to use the conda environment for this recipe,
you can get all dependencies installing
the <a class="reference external" href="https://github.com/lab-cosmo/pet-mad">PET-MAD package</a>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip<span class="w"> </span>install<span class="w"> </span>pet-mad
</pre></div>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">ase.io</span>

<span class="c1"># i-PI scripting utilities</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">chemiscope</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">metatensor.torch.atomistic</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ipi.utils.parsing</span><span class="w"> </span><span class="kn">import</span> <span class="n">read_output</span><span class="p">,</span> <span class="n">read_trajectory</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ipi.utils.scripting</span><span class="w"> </span><span class="kn">import</span> <span class="n">InteractiveSimulation</span>

<span class="c1"># pet-mad ASE calculator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pet_mad.calculator</span><span class="w"> </span><span class="kn">import</span> <span class="n">PETMADCalculator</span>


<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="nb">__import__</span><span class="p">(</span><span class="s2">&quot;builtins&quot;</span><span class="p">),</span> <span class="s2">&quot;get_ipython&quot;</span><span class="p">):</span>
    <span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">run_line_magic</span><span class="p">(</span><span class="s2">&quot;matplotlib&quot;</span><span class="p">,</span> <span class="s2">&quot;inline&quot;</span><span class="p">)</span>  <span class="c1"># noqa: F821</span>
</pre></div>
</div>
<section id="fetch-pet-mad-and-export-the-model">
<h2>Fetch PET-MAD and export the model<a class="headerlink" href="#fetch-pet-mad-and-export-the-model" title="Link to this heading">¶</a></h2>
<p>We first download the latest version of the PET-MAD model, and
export the model as a torchscript file.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># downloads the model checkpoint and export it</span>
<span class="n">model_filename</span> <span class="o">=</span> <span class="s2">&quot;pet-mad-latest.pt&quot;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">model_filename</span><span class="p">):</span>
    <span class="n">calculator</span> <span class="o">=</span> <span class="n">PETMADCalculator</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="s2">&quot;latest&quot;</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
    <span class="n">calculator</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model_filename</span><span class="p">)</span>
</pre></div>
</div>
<p>The model can also be loaded from this torchscript dump, which often
speeds up calculation as it involves compilation, and is functionally
equivalent unless you plan on fine-tuning, or otherwise modifying
the model.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">calculator</span> <span class="o">=</span> <span class="n">mta</span><span class="o">.</span><span class="n">ase_calculator</span><span class="o">.</span><span class="n">MetatensorCalculator</span><span class="p">(</span><span class="n">model_filename</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="non-conservative-forces">
<h2>Non-conservative forces<a class="headerlink" href="#non-conservative-forces" title="Link to this heading">¶</a></h2>
<p>Interatomic potentials are typically used to compute the forces acting
on the atoms by differentiating with respect to atomic positions, i.e. if</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[V(\mathbf{r}_1, \mathbf{r}_2, \ldots \mathbf{r}_n)\]</div>
</div>
<p>is the potential for an atomic configuration then the force acting on
atom <span class="math notranslate nohighlight">\(i\)</span> is</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\mathbf{f}_i = \partial V/\partial \mathbf{r}_i\]</div>
</div>
<p>Even though the early ML-based interatomic potentials followed this route,
computing forces directly as a function of the atomic coordinates,
as additional heads of the same model that computes <span class="math notranslate nohighlight">\(V\)</span>,
is computationally more efficient (between 2x and 3x faster).
The <cite>MetatensorCalculator</cite> class allows one to choose between
conservative (back-propagated) and non-conservative (direct)
force evaluation</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">structure</span> <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;data/bmimcl.xyz&quot;</span><span class="p">)</span>

<span class="n">structure</span><span class="o">.</span><span class="n">calc</span> <span class="o">=</span> <span class="n">calculator</span>
<span class="n">energy_c</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">get_potential_energy</span><span class="p">()</span>
<span class="n">forces_c</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">get_forces</span><span class="p">()</span>

<span class="n">calculator_nc</span> <span class="o">=</span> <span class="n">mta</span><span class="o">.</span><span class="n">ase_calculator</span><span class="o">.</span><span class="n">MetatensorCalculator</span><span class="p">(</span>
    <span class="n">model_filename</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">,</span> <span class="n">non_conservative</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="n">structure</span><span class="o">.</span><span class="n">calc</span> <span class="o">=</span> <span class="n">calculator_nc</span>
<span class="n">energy_nc</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">get_potential_energy</span><span class="p">()</span>
<span class="c1"># forces_nc = structure.get_forces() # temporarily broken</span>
</pre></div>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Energy:</span><span class="se">\n</span><span class="s2">  Conservative: </span><span class="si">{</span><span class="n">energy_c</span><span class="si">:</span><span class="s2">.8</span><span class="si">}</span><span class="se">\n</span><span class="s2">  Non-conserv.: </span><span class="si">{</span><span class="n">energy_nc</span><span class="si">:</span><span class="s2">.8</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Energy:
  Conservative: -2378.8296
  Non-conserv.: -2378.8296
</pre></div>
</div>
</section>
<section id="energy-conservation-in-nve-molecular-dynamics">
<h2>Energy conservation in NVE molecular dynamics<a class="headerlink" href="#energy-conservation-in-nve-molecular-dynamics" title="Link to this heading">¶</a></h2>
<p>Molecular dynamics simply integrates Hamilton’s equations</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\dot{\mathbf{r}}_i = \mathbf{p}_i/m_i \quad \dot{\mathbf{p}}_i = \mathbf{f}_i\]</div>
</div>
<p>to evolve in time the atomic positions. When the forces are the
derivatives of a potential energy <span class="math notranslate nohighlight">\(V\)</span>, these equations conserve
the total energy <span class="math notranslate nohighlight">\(H = V+\sum_i\mathbf{p}_i^2/2m_i\)</span>.</p>
<p>Finite time step integrators only conserve energy approximately, but
usually stable dynamics implies a high level of conservation, and no
long-time drift. Here we demonstrate the impact of direct force
prediction on energy conservation, using a short MD trajectory of
1-Butyl-3-methylimidazolium chloride (BMIM-Cl).</p>
<section id="conservative-forces">
<h3>Conservative forces<a class="headerlink" href="#conservative-forces" title="Link to this heading">¶</a></h3>
<p>First, we run a few steps computing forces as derivatives of the potential.
The MD setup is described in the <code class="docutils literal notranslate"><span class="pre">input-nve.xml</span></code> file.
This is a rather standard setup, with the key parameters being those
given in the <code class="docutils literal notranslate"><span class="pre">&lt;ffdirect&gt;</span></code> section.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;data/input-nve.xml&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">input_nve</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">input_nve</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;simulation verbosity=&quot;low&quot;&gt;
&lt;output prefix=&quot;nve-c&quot;&gt;
    &lt;properties stride=&quot;8&quot; filename=&quot;out&quot;&gt;
                [step, time{picosecond}, conserved{electronvolt}, temperature{kelvin},
        kinetic_md{electronvolt}, potential{electronvolt},
        pot_component(0){electronvolt}
                ]
    &lt;/properties&gt;
    &lt;trajectory filename=&quot;pos&quot; stride=&quot;16&quot; format=&quot;ase&quot;&gt; positions &lt;/trajectory&gt;
    &lt;trajectory filename=&quot;forces_c&quot; stride=&quot;16&quot; format=&quot;ase&quot;&gt; forces_component(0) &lt;/trajectory&gt;
    &lt;checkpoint stride=&quot;1000&quot;/&gt;
&lt;/output&gt;
&lt;total_steps&gt;32&lt;/total_steps&gt;
&lt;prng&gt;&lt;seed&gt;12345&lt;/seed&gt;&lt;/prng&gt;
&lt;ffdirect  name=&#39;cons&#39; pbc=&quot;false&quot;&gt;
    &lt;pes&gt;metatensor&lt;/pes&gt;
    &lt;parameters&gt;{template:data/bmimcl.xyz,model:pet-mad-latest.pt,device:cpu,non_conservative:False} &lt;/parameters&gt;
&lt;/ffdirect&gt;
&lt;system&gt;
    &lt;initialize nbeads=&quot;1&quot;&gt;
        &lt;file mode=&quot;ase&quot;&gt; data/bmimcl.xyz &lt;/file&gt;
        &lt;velocities mode=&quot;thermal&quot; units=&quot;kelvin&quot;&gt; 400.0 &lt;/velocities&gt;
    &lt;/initialize&gt;
    &lt;forces&gt;
        &lt;force forcefield=&quot;cons&quot;&gt;
        &lt;/force&gt;
    &lt;/forces&gt;

    &lt;motion mode=&quot;dynamics&quot;&gt;
        &lt;dynamics mode=&quot;nve&quot;&gt;
                &lt;timestep units=&quot;femtosecond&quot;&gt; 0.5 &lt;/timestep&gt;
        &lt;/dynamics&gt;
    &lt;/motion&gt;

&lt;/system&gt;
&lt;/simulation&gt;
</pre></div>
</div>
<p>The simulation can also be run from the command line using</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>i-pi<span class="w"> </span>data/input-nve.xml
</pre></div>
</div>
<p>but here we run interactively, timing the execution for comparison.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">sim</span> <span class="o">=</span> <span class="n">InteractiveSimulation</span><span class="p">(</span><span class="n">input_nve</span><span class="p">)</span>
<span class="n">steps_nve_c</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">time_nve_c</span> <span class="o">=</span> <span class="o">-</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">sim</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">steps_nve_c</span><span class="p">)</span>
<span class="n">time_nve_c</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">time_nve_c</span> <span class="o">/=</span> <span class="n">steps_nve_c</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># there&#39;s one extra energy evaluation at the beginning</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span> @system: Initializing system object
 @simulation: Initializing simulation object
@ RANDOM SEED: The seed used in this calculation was 12345
 @init_file: Initializing from file data/bmimcl.xyz. Dimension: length, units: automatic, cell_units: automatic
 @init_file: Initializing from file data/bmimcl.xyz. Dimension: length, units: automatic, cell_units: automatic
 @init_file: Initializing from file data/bmimcl.xyz. Dimension: length, units: automatic, cell_units: automatic
 @init_file: Initializing from file data/bmimcl.xyz. Dimension: length, units: automatic, cell_units: automatic
 @init_file: Initializing from file data/bmimcl.xyz. Dimension: length, units: automatic, cell_units: automatic
 @initializer: Resampling velocities at temperature 400.0 kelvin
 @system.bind: Binding the forces
 @simulation.run: Average timings at MD step       0. t/step: 3.59510e+00
</pre></div>
</div>
</section>
<section id="non-conservative-direct-forces">
<h3>Non-conservative (direct) forces<a class="headerlink" href="#non-conservative-direct-forces" title="Link to this heading">¶</a></h3>
<p>The PET-MAD model provides direct force predictions, that can be
activated with a <code class="docutils literal notranslate"><span class="pre">non_conservative:True</span></code> flag. This makes it very
simple to modify the NVE setup:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;data/input-nc-nve.xml&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">input_nve</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">input_nve</span><span class="p">[</span><span class="mi">574</span><span class="p">:</span><span class="mi">764</span><span class="p">])</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;ffdirect  name=&#39;nocons&#39; pbc=&quot;false&quot;&gt;
    &lt;pes&gt;metatensor&lt;/pes&gt;
    &lt;parameters&gt;{template:data/bmimcl.xyz,model:pet-mad-latest.pt,device:cpu,non_conservative:True} &lt;/parameters&gt;
&lt;/ffdirect&gt;
</pre></div>
</div>
<p>We run this example for longer (it is faster!) and time it
for comparison</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">sim</span> <span class="o">=</span> <span class="n">InteractiveSimulation</span><span class="p">(</span><span class="n">input_nve</span><span class="p">)</span>
<span class="n">steps_nve_nc</span> <span class="o">=</span> <span class="mi">128</span>
<span class="n">time_nve_nc</span> <span class="o">=</span> <span class="o">-</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">sim</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">steps_nve_nc</span><span class="p">)</span>
<span class="n">time_nve_nc</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">time_nve_nc</span> <span class="o">/=</span> <span class="n">steps_nve_nc</span> <span class="o">+</span> <span class="mi">1</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span> @system: Initializing system object
 @simulation: Initializing simulation object
@ RANDOM SEED: The seed used in this calculation was 12345
 @init_file: Initializing from file data/bmimcl.xyz. Dimension: length, units: automatic, cell_units: automatic
 @init_file: Initializing from file data/bmimcl.xyz. Dimension: length, units: automatic, cell_units: automatic
 @init_file: Initializing from file data/bmimcl.xyz. Dimension: length, units: automatic, cell_units: automatic
 @init_file: Initializing from file data/bmimcl.xyz. Dimension: length, units: automatic, cell_units: automatic
 @init_file: Initializing from file data/bmimcl.xyz. Dimension: length, units: automatic, cell_units: automatic
 @initializer: Resampling velocities at temperature 400.0 kelvin
 @system.bind: Binding the forces
 @simulation.run: Average timings at MD step       0. t/step: 1.24314e+00
 @open_backup: Backup performed: RESTART -&gt; #RESTART#0#
</pre></div>
</div>
<p>The simulation generates output files that can be parsed and visualized from Python.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">data_c</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">read_output</span><span class="p">(</span><span class="s2">&quot;nve-c.out&quot;</span><span class="p">)</span>
<span class="n">data_nc</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">read_output</span><span class="p">(</span><span class="s2">&quot;nve-nc.out&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>There is a large drift of the onserved quantity, that is also associated
in a rapid increase of the potential energy, which indicates that the lack
of conservative behavior distorts the sampled ensemble (and in fact, would
lead to loss of structural integrity in a longer run).</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data_c</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">data_c</span><span class="p">[</span><span class="s2">&quot;potential&quot;</span><span class="p">],</span> <span class="s2">&quot;b*&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$V$ (cons.)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data_c</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">data_c</span><span class="p">[</span><span class="s2">&quot;conserved&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;k*&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$H$ (cons.)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data_nc</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">data_nc</span><span class="p">[</span><span class="s2">&quot;potential&quot;</span><span class="p">],</span> <span class="s2">&quot;b--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$V$ (direct)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data_nc</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">data_nc</span><span class="p">[</span><span class="s2">&quot;conserved&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;k--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$H$ (direct)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;t / ps&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;energy / ev&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_pet-mad-nc_001.png" srcset="../../_images/sphx_glr_pet-mad-nc_001.png" alt="pet mad nc" class = "sphx-glr-single-img"/><div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend object at 0x7f718d4bf020&gt;
</pre></div>
</div>
</section>
</section>
<section id="energy-conservation-at-low-cost-with-multiple-time-stepping">
<h2>Energy conservation at low-cost with multiple time stepping<a class="headerlink" href="#energy-conservation-at-low-cost-with-multiple-time-stepping" title="Link to this heading">¶</a></h2>
<p>Given that PET-MAD provides <em>both</em> direct and conservative forces, it
is possible to implement a simulation strategy that achieves a high
degree of energy conservation at a cost that is close to that of direct-force
MD. This relies on the multiple time stepping (MTS) idea, which is discussed
and demonstrated in <a class="reference external" href="https://atomistic-cookbook.org/examples/pi-mts-rpc/mts-rpc.html">this recipe</a>.</p>
<p>The key idea is to perform several steps of MD using the short timestep
needed to follow atomic motion, and a “cheap” force evaluator
<span class="math notranslate nohighlight">\(\mathbf{f}_{\mathrm{fast}}\)</span>, and then
apply a correction <span class="math notranslate nohighlight">\(\mathbf{f}_{\mathrm{slow}}\)</span> every <span class="math notranslate nohighlight">\(M\)</span>
of such steps. In this case, the fast forces are the direct predictions,
and the slow ones the difference between conservative and direct forces.</p>
<p>This simulation setup can be realized readily in i-PI.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;data/input-nc-nve-mts.xml&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">input_nve_mts</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>
</div>
<p>First, one can define two forcefields that compute conservative and
direct forces</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">input_nve_mts</span><span class="p">[</span><span class="mi">704</span><span class="p">:</span><span class="mi">1082</span><span class="p">])</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;ffdirect  name=&#39;cons&#39; pbc=&quot;false&quot;&gt;
    &lt;pes&gt;metatensor&lt;/pes&gt;
    &lt;parameters&gt;{template:data/bmimcl.xyz,model:pet-mad-latest.pt,device:cpu,non_conservative:False} &lt;/parameters&gt;
&lt;/ffdirect&gt;
&lt;ffdirect  name=&#39;nocons&#39; pbc=&quot;false&quot;&gt;
    &lt;pes&gt;metatensor&lt;/pes&gt;
    &lt;parameters&gt;{template:data/bmimcl.xyz,model:pet-mad-latest.pt,device:cpu,non_conservative:True} &lt;/parameters&gt;
&lt;/ffdirect&gt;
</pre></div>
</div>
<p>… then, use them in the definition of the systems, specifying how
to weight them at each MTS level</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">input_nve_mts</span><span class="p">[</span><span class="mi">1258</span><span class="p">:</span><span class="mi">1482</span><span class="p">])</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;forces&gt;
    &lt;force forcefield=&quot;cons&quot;&gt;
        &lt;mts_weights&gt;[1,0]&lt;/mts_weights&gt;
    &lt;/force&gt;
    &lt;force forcefield=&quot;nocons&quot;&gt;
        &lt;mts_weights&gt;[-1,1]&lt;/mts_weights&gt;
    &lt;/force&gt;
&lt;/forces&gt;
</pre></div>
</div>
<p>… and finally request the appropriate MTS discretization in the
integrator: this specifies that the inner loop should be executed 8
times, and the outer loop (which has an overall time step of 4 fs)
once per step</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">input_nve_mts</span><span class="p">[</span><span class="mi">1480</span><span class="p">:</span><span class="mi">1655</span><span class="p">])</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;motion mode=&quot;dynamics&quot;&gt;
    &lt;dynamics mode=&quot;nve&quot;&gt;
            &lt;timestep units=&quot;femtosecond&quot;&gt; 4 &lt;/timestep&gt;
        &lt;nmts&gt;[1,8]&lt;/nmts&gt;
    &lt;/dynamics&gt;
&lt;/motion&gt;
</pre></div>
</div>
<p>All of this happens behind the scenes, and the simulation is just run
as for the simpler MD cases. Note also that it is possible to combine
this with thermostatted or NPT dynamics, in a completely seamless manner</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">sim</span> <span class="o">=</span> <span class="n">InteractiveSimulation</span><span class="p">(</span><span class="n">input_nve_mts</span><span class="p">)</span>
<span class="n">nmts</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">steps_nve_mts</span> <span class="o">=</span> <span class="n">steps_nve_nc</span> <span class="o">//</span> <span class="n">nmts</span>
<span class="n">time_nve_mts</span> <span class="o">=</span> <span class="o">-</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">sim</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">steps_nve_mts</span><span class="p">)</span>
<span class="n">time_nve_mts</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">time_nve_mts</span> <span class="o">/=</span> <span class="n">steps_nve_mts</span> <span class="o">*</span> <span class="n">nmts</span> <span class="o">+</span> <span class="mi">1</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span> @system: Initializing system object
 @simulation: Initializing simulation object
@ RANDOM SEED: The seed used in this calculation was 12345
 @init_file: Initializing from file data/bmimcl.xyz. Dimension: length, units: automatic, cell_units: automatic
 @init_file: Initializing from file data/bmimcl.xyz. Dimension: length, units: automatic, cell_units: automatic
 @init_file: Initializing from file data/bmimcl.xyz. Dimension: length, units: automatic, cell_units: automatic
 @init_file: Initializing from file data/bmimcl.xyz. Dimension: length, units: automatic, cell_units: automatic
 @init_file: Initializing from file data/bmimcl.xyz. Dimension: length, units: automatic, cell_units: automatic
 @initializer: Resampling velocities at temperature 400.0 kelvin
 @system.bind: Binding the forces
 @simulation.run: Average timings at MD step       0. t/step: 1.06399e+01
 @open_backup: Backup performed: RESTART -&gt; #RESTART#1#
</pre></div>
</div>
<p>The MTS calculation recovers most of the speedup of direct forces</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Time per 0.5fs step:</span>
<span class="s2">Conservative forces: </span><span class="si">{</span><span class="n">time_nve_c</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> s/step</span>
<span class="s2">Direct forces:       </span><span class="si">{</span><span class="n">time_nve_nc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> s/step</span>
<span class="s2">MTS (M=8):           </span><span class="si">{</span><span class="n">time_nve_mts</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> s/step</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Time per 0.5fs step:
Conservative forces: 2.4260 s/step
Direct forces:       0.9275 s/step
MTS (M=8):           1.2169 s/step
</pre></div>
</div>
<p>… and the energy conservation is on par with the conservative
trajectory (although the actual trajectories would deviate from each other
due to accumulation of small errors, but the overall sampling is
reliable on a long timescale).</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">data_mts</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">read_output</span><span class="p">(</span><span class="s2">&quot;nve-nc-mts.out&quot;</span><span class="p">)</span>
<span class="n">trj_mts</span> <span class="o">=</span> <span class="n">read_trajectory</span><span class="p">(</span><span class="s2">&quot;nve-nc-mts.pos_0.extxyz&quot;</span><span class="p">)</span>
<span class="n">force_c_mts</span> <span class="o">=</span> <span class="n">read_trajectory</span><span class="p">(</span><span class="s2">&quot;nve-nc-mts.forces_c.extxyz&quot;</span><span class="p">)</span>
<span class="n">force_nc_mts</span> <span class="o">=</span> <span class="n">read_trajectory</span><span class="p">(</span><span class="s2">&quot;nve-nc-mts.forces_nc.extxyz&quot;</span><span class="p">)</span>
<span class="c1">#</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data_c</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">data_c</span><span class="p">[</span><span class="s2">&quot;potential&quot;</span><span class="p">],</span> <span class="s2">&quot;b*&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$V$ (cons.)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data_nc</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">data_nc</span><span class="p">[</span><span class="s2">&quot;potential&quot;</span><span class="p">],</span> <span class="s2">&quot;b--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$V$ (direct)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data_mts</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">data_mts</span><span class="p">[</span><span class="s2">&quot;potential&quot;</span><span class="p">],</span> <span class="s2">&quot;b-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$V$ (MTS)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data_c</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">data_c</span><span class="p">[</span><span class="s2">&quot;conserved&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;k*&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$H$ (cons.)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data_nc</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">data_nc</span><span class="p">[</span><span class="s2">&quot;conserved&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;k--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$H$ (direct)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data_mts</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">data_mts</span><span class="p">[</span><span class="s2">&quot;conserved&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;k-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$H$ (MTS)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;t / ps&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;energy / ev&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_pet-mad-nc_002.png" srcset="../../_images/sphx_glr_pet-mad-nc_002.png" alt="pet mad nc" class = "sphx-glr-single-img"/><div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend object at 0x7f71a2a8f590&gt;
</pre></div>
</div>
<p>i-PI prints out both force components for diagnostics, which
we can visualize along the (short) trajectory. The conservative
forces are shown in atom colors, and the direct predictions in red.
One sees clearly that the two predictions are quite close, so the
correction is small and can be successfully applied with a large
MTS stride.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">cs_forces_c</span> <span class="o">=</span> <span class="n">chemiscope</span><span class="o">.</span><span class="n">ase_vectors_to_arrows</span><span class="p">(</span>
    <span class="n">force_c_mts</span><span class="p">,</span> <span class="s2">&quot;forces_component&quot;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span>
<span class="p">)</span>
<span class="n">cs_forces_nc</span> <span class="o">=</span> <span class="n">chemiscope</span><span class="o">.</span><span class="n">ase_vectors_to_arrows</span><span class="p">(</span>
    <span class="n">force_nc_mts</span><span class="p">,</span> <span class="s2">&quot;forces_component&quot;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span>
<span class="p">)</span>
<span class="n">cs_forces_nc</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="s2">&quot;global&quot;</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;#aa0000&quot;</span>

<span class="n">chemiscope</span><span class="o">.</span><span class="n">show</span><span class="p">(</span>
    <span class="n">trj_mts</span><span class="p">,</span>
    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">,</span>
    <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">data_mts</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">][::</span><span class="mi">2</span><span class="p">],</span>
        <span class="s2">&quot;conserved&quot;</span><span class="p">:</span> <span class="n">data_mts</span><span class="p">[</span><span class="s2">&quot;conserved&quot;</span><span class="p">][::</span><span class="mi">2</span><span class="p">],</span>
        <span class="s2">&quot;potential&quot;</span><span class="p">:</span> <span class="n">data_mts</span><span class="p">[</span><span class="s2">&quot;potential&quot;</span><span class="p">][::</span><span class="mi">2</span><span class="p">],</span>
    <span class="p">},</span>
    <span class="n">shapes</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;forces_c&quot;</span><span class="p">:</span> <span class="n">cs_forces_c</span><span class="p">,</span>
        <span class="s2">&quot;forces_nc&quot;</span><span class="p">:</span> <span class="n">cs_forces_nc</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">settings</span><span class="o">=</span><span class="n">chemiscope</span><span class="o">.</span><span class="n">quick_settings</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="s2">&quot;potential&quot;</span><span class="p">,</span>
        <span class="n">structure_settings</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;unitCell&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;shape&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;forces_c&quot;</span><span class="p">,</span> <span class="s2">&quot;forces_nc&quot;</span><span class="p">]},</span>
        <span class="n">trajectory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">meta</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;MTS direct-forces MD for BMIM-Cl&quot;</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Initial configuration kindly provided &quot;</span>
        <span class="o">+</span> <span class="s2">&quot; by Moritz Schaefer and Fabian Zills&quot;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span>
</pre></div>
</div>
<!-- begin headers -->
<!-- Load all dependencies -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>

<!-- JS scripts -->
<script src="../../_static/chemiscope.min.js"></script>
<script src="../../_static/chemiscope-sphinx.js"></script>

<!-- CSS styles -->
<link rel="stylesheet" href="../../_static/chemiscope-sphinx.css" type="text/css" />
<!-- end headers -->

<!-- Warning Display -->
<div id="chsp-d5709317-01c9-497a-b1c6-87689feddb4d-warning-display" class="chemiscope-sphinx-warning">
    <p></p>
    <button type="button" aria-label="Close" onclick="hideElement('chsp-d5709317-01c9-497a-b1c6-87689feddb4d-warning-display')">
        &times;
    </button>
</div>
<div style="padding: 0.5rem 1.25rem" />

<!-- Loading Spinner -->
<div id="chsp-d5709317-01c9-497a-b1c6-87689feddb4d-loading" class="chemiscope-sphinx-spinner">
    <img src="../../_static/chemiscope-loading.svg" alt="Loading icon" />
</div>

<!-- Chemiscope Visualization -->
<div id="chsp-d5709317-01c9-497a-b1c6-87689feddb4d">
    <!-- This will be replaced by the chemiscope HTML -->
</div>

<!-- Load Visualization Script -->
<script>
    loadChemiscopeSphinx('chsp-d5709317-01c9-497a-b1c6-87689feddb4d', '../../_datasets/14afeae59c6ab1f2996f026e9ad1949b34c166298f30ca7c1c09ef09f41c88d9-fig_pet-mad-nc_001.json.gz', 'default', '2000.0');
</script>
<div class="output_subarea output_html rendered_html output_result">

</div>
<br />
<br /><p class="sphx-glr-timing"><strong>Total running time of the script:</strong> (6 minutes 6.294 seconds)</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-examples-pet-mad-nc-pet-mad-nc-py">
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/39b2d425db32b92d91541acf66033adb/pet-mad-nc.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">pet-mad-nc.ipynb</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/ccdb9f6f0cd80889180647c53c0c71ef/pet-mad-nc.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">pet-mad-nc.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-zip docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/c7b9e6285b32dd844b16c72f940d7ff7/pet-mad-nc.zip"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">recipe:</span> <span class="pre">pet-mad-nc.zip</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../pi-mts-rpc/mts-rpc.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Multiple time stepping and ring-polymer contraction</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="../flashmd/flashmd-demo.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Long-stride trajectories with a universal FlashMD model</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; BSD 3-Clause License, Copyright (c) 2025, The atomistic cookbook team
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">MD using direct-force predictions with PET-MAD</a><ul>
<li><a class="reference internal" href="#fetch-pet-mad-and-export-the-model">Fetch PET-MAD and export the model</a></li>
<li><a class="reference internal" href="#non-conservative-forces">Non-conservative forces</a></li>
<li><a class="reference internal" href="#energy-conservation-in-nve-molecular-dynamics">Energy conservation in NVE molecular dynamics</a><ul>
<li><a class="reference internal" href="#conservative-forces">Conservative forces</a></li>
<li><a class="reference internal" href="#non-conservative-direct-forces">Non-conservative (direct) forces</a></li>
</ul>
</li>
<li><a class="reference internal" href="#energy-conservation-at-low-cost-with-multiple-time-stepping">Energy conservation at low-cost with multiple time stepping</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script data-domain="atomistic-cookbook.org" defer="defer" src="https://plausible.io/js/script.file-downloads.hash.outbound-links.pageview-props.tagged-events.js"></script>
    <script src="../../_static/all-examples-data.js?v=3fbd0368"></script>
    <script src="../../_static/daily-recipe.js?v=b5e71911"></script>
    </body>
</html>